<?php

/**
 * @file
 * Contains quicklink.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_preprocess_html().
 */
function quicklink_preprocess_html(&$variables, $hook) {

  // Load current configuration.
  $config = \Drupal::config('quicklink.quicklinkconfig');
  $selector = $config->get('selector');

  // Check if local copy of the library exists. If it does not, use the CDN version.
  if (file_exists(drupal_get_path('module', 'quicklink') . '/js/quicklink.umd.js')) {
    $quicklink_library = 'quicklink/quicklink_local';
  }
  else {
    $quicklink_library = 'quicklink/quicklink_cdn';
  }

  $url_patterns_to_ignore =  ['user/logout']; // Automatically ignore the logout link.
  $allowed_domains =  [];

  // Populate and remove line returns from URL patterns to ignore.
  foreach (explode(PHP_EOL, $config->get('url_patterns_to_ignore')) as $value) {
    $url_patterns_to_ignore[] = str_replace("\r", '', $value);
  }

  // Populate and remove line returns from allowed domains.
  foreach (explode(PHP_EOL, $config->get('allowed_domains')) as $value) {
    $allowed_domains[] = str_replace("\r", '', $value);
  }

  // If user is anonymous OR  if "Prefetch for anonymous users only" is NOT selected, load library, load library.
  if (!$variables["logged_in"] || $config->get('prefetch_for_anonymous_users_onl') == 0) {
    $variables['#attached']['library'][] = $quicklink_library;
    $variables['#attached']['library'][] = 'quicklink/quicklink_init';

    if (!empty($selector)) {
      $variables['#attached']['drupalSettings']['quicklink']['selector'] = $selector;
    }

    if (!empty($allowed_domains[0])) {
      $variables['#attached']['drupalSettings']['quicklink']['allowed_domains'] = $allowed_domains;
    }

    if (!empty($url_patterns_to_ignore)) {
      $variables['#attached']['drupalSettings']['quicklink']['url_patterns_to_ignore'] = $url_patterns_to_ignore;
    }
  }
}
